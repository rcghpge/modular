load("//bazel:api.bzl", "modular_py_test", "requirement")

modular_py_test(
    name = "tests",
    srcs = glob(
        [
            "*.py",
            "pipelines/*.py",
        ],
    ),
    data = [
        "//GenericML:MGPRT",
        "//KGEN:CompilerRT",
        "//SDK/lib/API/python/tests/serve/testdata",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "MAX_SERVE_DISABLE_TELEMETRY": "True",
        "MAX_SERVE_TESTDATA": "SDK/lib/API/python/tests/serve/testdata",
    },
    deps = [
        "//SDK/lib/API/python/max/pipelines/kv_cache",
        "//SDK/lib/API/python/max/serve",
        "//SDK/lib/API/python/max/serve/grpc_serve",
        "//SDK/lib/API/python/max/serve/pipelines",
        "//SDK/lib/API/python/max/serve/router",
        "//SDK/lib/API/python/max/serve/scheduler",
        "//SDK/lib/API/python/max/serve/schemas",
        "//SDK/lib/API/python/max/serve/telemetry",
        requirement("async-asgi-testclient"),
        requirement("fastapi"),
        requirement("gguf"),
        requirement("hypothesis"),
        requirement("opentelemetry-sdk"),
        requirement("pytest-asyncio"),
        requirement("pytest-grpc"),
        requirement("sentencepiece"),
        requirement("sse-starlette"),
        requirement("sseclient-py"),
        requirement("transformers"),
    ],
)
