load("//bazel:api.bzl", "modular_py_test")

modular_py_test(
    name = "tests",
    srcs = glob(["pytests/**/*.py"]),
    data = [
        "//KGEN:CompilerRT",
        "//ModularFramework/tools/mof",
        "//SDK/integration-test:test_user_op",
        "//SDK/test/API/graph/python/pytests/testdata",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "BAZEL": "true",
        "CUSTOM_OPS_PATH": "$(location //SDK/integration-test:test_user_op)",
        "MODULAR_PATH": ".",
        "GRAPH_TESTDATA": "SDK/test/API/graph/python/pytests/testdata",
    },
    mojo_deps = [
        "//SDK/integration-test:test_user_op",
    ],
    target_compatible_with = select({
        # TODO: Sanitizer libs aren't available when python loads pybind shared libs
        "//:asan": ["@platforms//:incompatible"],
        "//:tsan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    deps = ["//SDK/lib/API/python:max_engine"],
)
