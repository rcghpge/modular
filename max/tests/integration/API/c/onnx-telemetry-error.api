// UNSUPPORTED: Windows
// RUN: mkdir -p %t

// RUN: rm -f %t/error-metrics
// RUN: rm -f %t/error-log
// RUN: MODULAR_TELEMETRY_EXPORTERS_METRICS_FILE_PATH=%t/error-metrics MODULAR_TELEMETRY_EXPORTERS_LOGS_FILE_PATH=%t/error-log not modular-api-executor %s 2>&1 | FileCheck %s --check-prefix=CHECK-OUTPUT
// RUN: cat %t/error-metrics | FileCheck %s --check-prefix=CHECK-METRICS
// RUN: cat %t/error-log | FileCheck %s --check-prefix=CHECK-LOGS


module attributes {onnx.ir_version = 7 : si64} {
  monnx.graph @torch_jit(%arg0: tensor<2x2xf32>, %arg1: tensor<2x2xf32>) -> tensor<2x2xf32> {
    %0 = "monnx.mul_v14"(%arg0, %arg1) {onnxNodeName = "/Mul"} : (tensor<2x2xf32>, tensor<2x2xf32>) -> tensor<*xf32>
    %1 = "monnx.rlu_v14"(%0) {onnxNodeName = "/Relu"} : (tensor<*xf32>) -> tensor<2x2xf32>
    monnx.output %1 : tensor<2x2xf32>
  }
}

// CHECK-OUTPUT: failed to legalize operation 'monnx.rlu_v14' that was explicitly marked illegal

// CHECK-METRICS-DAG: max.engine.failure.graph_lowering_error
// CHECK-METRICS-DAG: value{{.*}}: 1
// CHECK-METRICS-DAG: max.engine.failure.compilation_error
// CHECK-METRICS-DAG: value{{.*}}: 1

// CHECK-LOGS-DAG: max.engine.error_code: max.engine.failure.graph_lowering_error
// CHECK-LOGS-DAG: failed to legalize operation 'monnx.rlu_v14' that was explicitly marked illegal
