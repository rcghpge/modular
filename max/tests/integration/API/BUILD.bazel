load("//bazel:api.bzl", "lit_tests", "requirement")

filegroup(
    name = "pytest_inputs",
    srcs = [
        "Inputs/dynamic-model.mlir",
        "Inputs/named-inputs.mlir",
        "Inputs/no-inputs.mlir",
        "Inputs/relu3x100x100.onnx",
        "Inputs/relu3x100x100.torchscript",
        "Inputs/scalar-input.mlir",
        "c/mo-model.api",
    ],
    visibility = [":__subpackages__"],
)

filegroup(
    name = "inputs",
    srcs = glob(["**/*.mlir"]),
    visibility = [":__subpackages__"],
)

lit_tests(
    name = "test",
    size = "large",
    srcs = glob(
        [
            "**/*.api",
            "**/*.mojo",
        ],
        exclude = [
            "mojo/test_devicetensor_gpu.mojo",
        ],
    ),
    custom_substitutions = {
        "%pytorch_generated_tests_dir": "../../../../PyTorch/test/utils",
        "%onnx_test_models_dir": "../../../../../onnx+/onnx/backend/test/data/node",
    },
    data = [
        ":inputs",
        "//PyTorch:modular-framework-torch-ext",
        "//PyTorch/test/utils:pytorch-generated-tests",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test:inputs",
        "@onnx//onnx/backend/test/data/node:test_abs",
    ],
    env = {
        "MODULAR_MAX_ENABLE_MODEL_IR_CACHE": "false",
    },
    mojo_deps = [
        "//SDK/lib/API/mojo/max/max",
        "//open-source/mojo/stdlib/stdlib",
        "//Kernels/mojo/register",
    ],
    tools = [
        "//GenericML/tools/mt",
        "//KGEN:ptxas",
        "//KGEN/tools/mojo",
        "//SDK/tools/modular-api-executor",
    ],
    deps = [
        requirement("numpy"),
        requirement("requests"),
        requirement("torch"),
        requirement("torchvision"),
    ],
)

lit_tests(
    name = "gpu-test",
    size = "large",
    srcs = ["mojo/test_devicetensor_gpu.mojo"],
    data = [":inputs"],
    env = {
        "MODULAR_MAX_ENABLE_MODEL_IR_CACHE": "false",
    },
    gpu_constraints = ["//:has_gpu"],
    mojo_deps = [
        "//SDK/lib/API/mojo/max/max",
        "//open-source/mojo/stdlib/stdlib",
    ],
    tags = ["gpu"],
    tools = [
        "//KGEN:ptxas",
        "//KGEN/tools/mojo",
    ],
)
