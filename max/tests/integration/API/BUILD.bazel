load("//bazel:api.bzl", "lit_tests", "requirement")

filegroup(
    name = "pytest_inputs",
    srcs = [
        "Inputs/dynamic-model.mlir",
        "Inputs/named-inputs.mlir",
        "Inputs/no-inputs.mlir",
        "Inputs/scalar-input.mlir",
        "c/mo-model.api",
    ],
    visibility = [":__subpackages__"],
)

filegroup(
    name = "inputs",
    srcs = glob(["**/*.mlir"]),
    visibility = [":__subpackages__"],
)

lit_tests(
    name = "test",
    size = "large",
    srcs = glob(
        [
            "**/*.api",
        ],
    ),
    data = [
        ":inputs",
        "//SDK/integration-test:inputs",
    ],
    env = {
        "MODULAR_MAX_ENABLE_MODEL_IR_CACHE": "false",
    },
    mojo_deps = [
        "@mojo//:register",
        "@mojo//:stdlib",
    ],
    tags = ["gpu"],
    tools = [
        "//GenericML/tools/mt",
        "//KGEN/tools/mojo",
        "//SDK/tools/modular-api-executor",
    ],
    deps = [
        requirement("numpy"),
        requirement("requests"),
        requirement("torch"),
        requirement("torchvision"),
    ],
)
