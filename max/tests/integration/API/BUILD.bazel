load("@pip_deps//:requirements.bzl", "requirement")
load("//utils/bazel/build/rules:lit.bzl", "lit_tests")

lit_tests(
    name = "test",
    size = "large",
    srcs = glob([
        "**/*.api",
        "**/*.mojo",
    ]),
    available_features = [
        "GENERATED_ONNX_TESTS",
        "GENERATED_TESTS",
        "mtorch",
        "numpy",
        "pytorch-generated-tests",
        "requests",
    ],
    custom_substitutions = {
        "%pytorch_generated_tests_dir": "../../../../PyTorch/test/utils",
        "%onnx_test_models_dir": "../../../../../onnx~/onnx/backend/test/data/node",
        "%libpython": "$(rlocationpath //:libpython)",
    },
    data = glob(["**/*.mlir"]) + [
        "//:libpython",
        "//GenericML:DeviceDriver",
        "//GenericML:modular-framework-common",
        "//KGEN:CompilerRT",
        "//ModelServing:ServeRT",
        "//ModularFramework/tools/mof",
        "//PyTorch:modular-framework-torch-ext",
        "//PyTorch/test/utils:pytorch-generated-tests",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test:inputs",
        "@llvm-project//compiler-rt:orc_rt",
        "@onnx//onnx/backend/test/data/node:test_abs",
    ],
    env = {
        "MODULAR_MAX_ENABLE_MODEL_IR_CACHE": "false",
    },
    mojo_deps = [
        "//SDK/lib/API/mojo/max",
        "//open-source/mojo/stdlib/stdlib",
        "//Kernels/mojo/register",
    ],
    path = "$(rlocationpath //CUDASupport/tools/is-cuda-available)",
    tags = [
        "no-sandbox",  # These tests use openmp which validates only 1 shared library is loaded at the same time, the libraries in the sandbox appear different so running them in parallel fails otherwise.
    ],
    target_compatible_with = select({
        "//:asan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    tools = [
        "//CUDASupport/tools/is-cuda-available",
        "//GenericML/tools/mt",
        "//KGEN/tools/mojo",
        "//SDK/tools/modular-api-executor",
    ],
    deps = [
        requirement("numpy"),
        requirement("requests"),
        requirement("torch"),
        requirement("torchvision"),
    ],
)
