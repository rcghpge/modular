load("@pip_deps//:requirements.bzl", "requirement")
load("//bazel:api.bzl", "modular_py_test")
load("//utils/bazel/build/rules:mojo.bzl", "mojo_test_environment")

mojo_test_environment(
    name = "test_env",
    data = [
        "//SDK/integration-test:test_user_op",
    ],
)

modular_py_test(
    name = "tests",
    srcs = glob(["pytests/**/*.py"]),
    data = [
        ":test_env",
        "//CUDASupport/tools/is-cuda-available",
        "//KGEN:CompilerRT",
        "//ModularFramework/tools/mof",
        "//ONNX/tools/onnx:monnx",
        "//PyTorch:TorchRuntimePlugin",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test:test_user_op",
        "//SDK/integration-test/EngineAPI:inputs",
        "//SDK/integration-test/EngineAPI:pytest_inputs",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "BAZEL": "true",
        "CUSTOM_OPS_PATH": "$(location //SDK/integration-test:test_user_op)",
        "MODULAR_IS_CUDA_AVAILABLE": "$(location //CUDASupport/tools/is-cuda-available)",
        "MODULAR_MOJO_COMPILERRT_PATH": "$(location //KGEN:CompilerRT)",
        "MODULAR_MOJO_IMPORT_PATH": "$(COMPUTED_IMPORT_PATH)",
        "MODULAR_MOJO_ORCRT_PATH": "$(location @llvm-project//compiler-rt:orc_rt)",
        "MODULAR_PATH": ".",
    },
    target_compatible_with = select({
        # TODO: Sanitizer libs aren't available when python loads pybind shared libs
        "//:asan": ["@platforms//:incompatible"],
        "//:tsan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    toolchains = [":test_env"],
    deps = [
        "//SDK/lib/EngineAPI/python:max_engine",
        requirement("torch"),
    ],
)
