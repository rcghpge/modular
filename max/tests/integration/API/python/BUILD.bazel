load("@pip_deps//:requirements.bzl", "requirement")
load("//bazel:api.bzl", "modular_py_test")

modular_py_test(
    name = "tests",
    srcs = glob([
        "pytests/**/*.py",
        "graph_tests/**/*.py",
    ]),
    data = [
        "//:libpython",
        "//KGEN:CompilerRT",
        "//ModularFramework/tools/mof",
        "//ONNX/tools/onnx:monnx",
        "//PyTorch:TorchRuntimePlugins",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test:counter_ops",
        "//SDK/integration-test:test_user_op",
        "//SDK/integration-test/EngineAPI:inputs",
        "//SDK/integration-test/EngineAPI:pytest_inputs",
        "//SDK/test/API/graph/python/pytests/testdata",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "BAZEL": "true",
        "MODULAR_COUNTER_OPS_PATH": "$(location //SDK/integration-test:counter_ops)",
        "CUSTOM_OPS_PATH": "$(location //SDK/integration-test:test_user_op)",
        "MODULAR_PATH": ".",
        "GRAPH_TESTDATA": "SDK/test/API/graph/python/pytests/testdata",
    },
    mojo_deps = [
        "//SDK/integration-test:test_user_op",
        "//PyTorch/test/utils/custom_ops",
        "//Kernels/mojo/buffer",
        "//Kernels/mojo/algorithm",
        "//Kernels/mojo/register",
        "//Kernels/mojo/runtime",
        "//open-source/mojo/stdlib/stdlib",
    ],
    target_compatible_with = select({
        # TODO: Sanitizer libs aren't available when python loads pybind shared libs
        "//:asan": ["@platforms//:incompatible"],
        "//:tsan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    deps = [
        "//SDK/lib/API/python:max_engine",
        "//SDK/public/max-repo/pipelines/python/llama3",
        "//SDK/public/max-repo/pipelines/python/nn",
        requirement("torch"),
        requirement("transformers"),
        requirement("hypothesis"),
        requirement("sentencepiece"),
        requirement("gguf"),
    ],
)

modular_py_test(
    name = "cuda_tests",
    srcs = glob(["gpu_tests/**/*.py"]),
    data = [
        "//KGEN:CompilerRT",
        "//ModularFramework/tools/mof",
        "//ONNX/tools/onnx:monnx",
        "//PyTorch:TorchRuntimePlugins",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test:test_user_op",
        "//SDK/integration-test/EngineAPI:inputs",
        "//SDK/integration-test/EngineAPI:pytest_inputs",
        "//SDK/test/API/graph/python/pytests/testdata",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "BAZEL": "true",
        "CUSTOM_OPS_PATH": "$(location //SDK/integration-test:test_user_op)",
        "MODULAR_PATH": ".",
        "GRAPH_TESTDATA": "SDK/test/API/graph/python/pytests/testdata",
    },
    tags = ["gpu"],
    target_compatible_with = select({
        # TODO: Sanitizer libs aren't available when python loads pybind shared libs
        "//:asan": ["@platforms//:incompatible"],
        "//:tsan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    deps = [
        "//SDK/lib/API/python:max_engine",
    ],
)
