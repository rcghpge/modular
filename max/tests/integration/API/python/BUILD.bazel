load("@pip_deps//:requirements.bzl", "requirement")
load("//bazel:api.bzl", "modular_py_test")

modular_py_test(
    name = "tests",
    srcs = glob(["pytests/**/*.py"]),
    data = [
        "//CUDASupport/tools/is-cuda-available",
        "//KGEN:CompilerRT",
        "//ModularFramework/tools/mof",
        "//ONNX/tools/onnx:monnx",
        "//PyTorch:TorchRuntimePlugin",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test:test_user_op",
        "//SDK/integration-test/EngineAPI:inputs",
        "//SDK/integration-test/EngineAPI:pytest_inputs",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "BAZEL": "true",
        "CUSTOM_OPS_PATH": "$(location //SDK/integration-test:test_user_op)",
        "MODULAR_PATH": ".",
        "MODULAR_IS_CUDA_AVAILABLE": "$(location //CUDASupport/tools/is-cuda-available)",
    } | select({
        # NOTE: Hack to make sure we don't cache test results that ran without cuda
        "//:has_cuda_setting": {"MODULAR_INVALIDATE_CUDA": "true"},
        "//conditions:default": {},
    }),
    mojo_deps = [
        "//SDK/integration-test:test_user_op",
    ],
    tags = ["gpu"],
    target_compatible_with = select({
        # TODO: Sanitizer libs aren't available when python loads pybind shared libs
        "//:asan": ["@platforms//:incompatible"],
        "//:tsan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    deps = [
        "//SDK/lib/EngineAPI/python:max_engine",
        requirement("torch"),
    ],
)
