load("@pip_deps//:requirements.bzl", "requirement")
load("//bazel:api.bzl", "modular_py_test")

modular_py_test(
    name = "tests",
    srcs = glob([
        "pytests/**/*.py",
        "graph_tests/**/*.py",
    ]),
    data = [
        "//CUDASupport/tools/is-cuda-available",
        "//KGEN:CompilerRT",
        "//ModularFramework/tools/mof",
        # TODO(SDLC-918): remove when landed
        "//Kernels/mojo/Mogg:MOGG.lib.mlirbc",
        "//Kernels/mojo/Mogg:MOGGPrimitives.lib.mlirbc",
        "//ONNX/tools/onnx:monnx",
        "//PyTorch:TorchRuntimePlugins",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test:test_user_op",
        "//SDK/integration-test/EngineAPI:inputs",
        "//SDK/integration-test/EngineAPI:pytest_inputs",
        "//SDK/test/API/graph/python:testdata",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "BAZEL": "true",
        "CUSTOM_OPS_PATH": "$(location //SDK/integration-test:test_user_op)",
        "MODULAR_PATH": ".",
        "MODULAR_IS_CUDA_AVAILABLE": "false",  # TODO: Run tests on GPU if they get re-enabled
        "GRAPH_TESTDATA": "SDK/test/API/graph/python/pytests/testdata",
    },
    mojo_deps = [
        "//SDK/integration-test:test_user_op",
    ],
    target_compatible_with = select({
        # TODO: Sanitizer libs aren't available when python loads pybind shared libs
        "//:asan": ["@platforms//:incompatible"],
        "//:tsan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    deps = [
        "//ModularFramework/examples/pipelines_python/llama3",
        "//SDK/lib/EngineAPI/python:max_engine",
        requirement("torch"),
        requirement("transformers"),
        requirement("hypothesis"),
        requirement("sentencepiece"),
        requirement("gguf"),
    ],
)
