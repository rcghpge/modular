load("//bazel:api.bzl", "modular_py_test", "requirement")

package(default_visibility = [
    "//:__pkg__",
    "//SDK/integration-test:__subpackages__",
    "//max/tests:__subpackages__",
    "//oss/modular/max/tests:__subpackages__",
])

[
    modular_py_test(
        name = src.replace(".py", ""),
        timeout = "long",
        srcs = [src],
        args = [
            "-n",
            "auto",
        ],
        tags = [
                   "no-pydeps",  # TODO: Fix and re-enable
               ] + (["manual"] if src in [
                   # FIXME: SDLC-2904
                   "test_module_gpt2.py",
                   "rope/test_yarn.py",
               ] else []) +
               (["skip-external-ci"] if src in [
                   # FIXME: SDLC-3032
                   "rope/test_rope.py",
                   "test_module.py",
               ] else []),
        target_compatible_with = select({
            "@platforms//os:macos": ["@platforms//:incompatible"],  # FIXME: MOCO-2411
            "//conditions:default": [],
        }) + select({
            "//:asan": ["@platforms//:incompatible"],  # Too slow under ASAN
            "//conditions:default": [],
        }),
        deps = [
            "//max/python/max",
            "//max/tests/integration:hf_repo_lock",
            requirement("pytest-xdist"),
        ],
    )
    for src in glob(["**/*.py"])
]
