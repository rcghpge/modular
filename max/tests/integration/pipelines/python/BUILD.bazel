load("@pip_deps//:requirements.bzl", "requirement")
load("//bazel:api.bzl", "modular_py_test")

py_binary(
    name = "evaluate_llama",
    srcs = ["evaluate_llama.py"],
    data = [
        "//KGEN:CompilerRT",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "MODULAR_MOJO_MAX_ORCRT_PATH": "$(location @llvm-project//compiler-rt:orc_rt)",
        "MODULAR_MOJO_MAX_COMPILERRT_PATH": "$(location //KGEN:CompilerRT)",
    },
    imports = ["."],
    visibility = ["//visibility:public"],
    deps = [
        "//SDK/public/max-repo/pipelines/python/llama3",
        requirement("click"),
    ],
)

modular_py_test(
    name = "tests",
    srcs = glob([
        "test_*.py",
    ]) + [
        "conftest.py",
    ],
    data = [
        "//KGEN:CompilerRT",
        "//ModularFramework/tools/mof",
        "//ONNX/tools/onnx:monnx",
        "//PyTorch:TorchRuntimePlugins",
        "//PyTorch/tools/torch:mtorch",
        "//SDK/integration-test/pipelines/python/testdata",
        "@llvm-project//compiler-rt:orc_rt",
    ],
    env = {
        "BAZEL": "true",
        "MODULAR_PATH": ".",
        "PIPELINES_TESTDATA": "SDK/integration-test/pipelines/python/testdata",
    },
    requires_gpu = False,
    target_compatible_with = select({
        # TODO: Sanitizer libs aren't available when python loads pybind shared libs
        "//:asan": ["@platforms//:incompatible"],
        "//:tsan": ["@platforms//:incompatible"],
        "//conditions:default": [],
    }),
    deps = [
        ":evaluate_llama",
        "//SDK/lib/API/python:max_engine",
        "//SDK/public/max-repo/pipelines/python/llama3",
        "//SDK/public/max-repo/pipelines/python/utils",
        "//Support/python:support",
        requirement("hypothesis"),
        requirement("transformers"),
    ],
)
