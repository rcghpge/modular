# Common code shared by different pipeline tests.

load(
    "//bazel:api.bzl",
    "modular_py_library",
    "requirement",
)

modular_py_library(
    name = "test_common",
    srcs = ["__init__.py"],
    imports = ["."],
    deps = [
        requirement("pytest"),
        requirement("numpy"),
        ":distance_metrics",
        ":evaluate",
        ":evaluate_embeddings",
        ":mocks",
        ":ndarray_from_tensor_type",
        ":numpy_encoder",
        ":path",
        ":registry",
        ":torch_utils",
    ],
)

modular_py_library(
    name = "ndarray_from_tensor_type",
    srcs = ["ndarray_from_tensor_type.py"],
    imports = [".."],
    deps = [
        requirement("numpy"),
        "//SDK/lib/API/python/max/graph",
    ],
)

modular_py_library(
    name = "numpy_encoder",
    srcs = ["numpy_encoder.py"],
    imports = [".."],
    deps = [
        requirement("numpy"),
    ],
)

modular_py_library(
    name = "distance_metrics",
    srcs = ["distance_metrics.py"],
    imports = [".."],
    deps = [
        requirement("numpy"),
        requirement("torch"),
    ],
)

modular_py_library(
    name = "evaluate",
    srcs = ["evaluate.py"],
    imports = [".."],
    deps = [
        requirement("numpy"),
        requirement("requests"),
        "//SDK/lib/API/python/max/driver",
        "//SDK/lib/API/python/max/pipelines",
    ],
)

modular_py_library(
    name = "evaluate_embeddings",
    srcs = ["evaluate_embeddings.py"],
    imports = [".."],
    deps = [
        "//SDK/lib/API/python/max/driver",
        "//SDK/lib/API/python/max/pipelines",
    ],
)

modular_py_library(
    name = "path",
    srcs = ["path.py"],
    imports = [".."],
    deps = [
        "//SDK/lib/API/python/max/pipelines/architectures",
        "@rules_python//python/runfiles",
    ],
)

modular_py_library(
    name = "registry",
    srcs = ["registry.py"],
    imports = [".."],
    deps = [
        requirement("pytest"),
        "//SDK/lib/API/python/max/pipelines",
        "//SDK/lib/API/python/max/pipelines/architectures",
        "@rules_python//python/runfiles",
    ],
)

modular_py_library(
    name = "torch_utils",
    srcs = ["torch_utils.py"],
    imports = [".."],
    visibility = ["//visibility:public"],
    deps = [
        requirement("accelerate"),  # Required to run torch models on GPU.
        requirement("pillow"),
        requirement("torch"),
        requirement("transformers"),
    ],
)

modular_py_library(
    name = "mocks",
    srcs = [
        "mocks/__init__.py",
        "mocks/tokenizer.py",
    ],
    imports = [".."],
    visibility = ["//visibility:public"],
    deps = [
        "//SDK/lib/API/python/max/pipelines",
        requirement("transformers"),
        requirement("setuptools"),
    ],
)
